<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=yes"><title>JWT认证系统尝鲜 | Sweet House</title><meta name=description content="Everyday is a holiday"><meta name=bytedance-verification-code content="MmXZwSvr8lAvM1hIXSkm"><meta name=author content="[Ryuchen WangOO]"><link rel=icon href=/favicon.ico><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/prismjs@1.22.0/themes/prism-dark.min.css><link rel=stylesheet href=/dist/main.4707e15c5ca4eab5da71.min.css><link rel=stylesheet href=/css/shortcodes.css><link rel=canonical href=https://ryuchen.club/posts/0x000006/><meta property="og:title" content="JWT认证系统尝鲜"><meta property="og:description" content="最近在&rsquo;正式退休&rsquo;之后，并不能完全闲着啊，所以想起来之前给学校的老师做的一个项目，并没有完全做完，于是想正好借助这个机会，先把 angluar 学习起来，然后顺便再把之前一些感兴趣的并没有在工作中正式使用的一些技术栈给用上~"><meta property="og:type" content="article"><meta property="og:url" content="https://ryuchen.club/posts/0x000006/"><meta property="og:image" content="https://ryuchen.club/JWT.png"><meta property="article:published_time" content="2019-08-01T00:00:00+00:00"><meta property="article:modified_time" content="2019-08-01T00:00:00+00:00"><meta property="og:see_also" content="https://ryuchen.club/posts/0x000015/"><meta property="og:see_also" content="https://ryuchen.club/posts/0x000014/"><meta property="og:see_also" content="https://ryuchen.club/posts/0x000013/"><meta property="og:see_also" content="https://ryuchen.club/posts/0x000011/"><meta property="og:see_also" content="https://ryuchen.club/posts/0x000012/"><meta property="og:see_also" content="https://ryuchen.club/posts/0x000010/"><meta itemprop=name content="JWT认证系统尝鲜"><meta itemprop=description content="最近在&rsquo;正式退休&rsquo;之后，并不能完全闲着啊，所以想起来之前给学校的老师做的一个项目，并没有完全做完，于是想正好借助这个机会，先把 angluar 学习起来，然后顺便再把之前一些感兴趣的并没有在工作中正式使用的一些技术栈给用上~"><meta itemprop=datePublished content="2019-08-01T00:00:00+00:00"><meta itemprop=dateModified content="2019-08-01T00:00:00+00:00"><meta itemprop=wordCount content="530"><meta itemprop=image content="https://ryuchen.club/JWT.png"><meta itemprop=keywords content="django,angular,ng-alain,"></head><body><nav class="navbar navbar-expand-md navbar-light bg-light fixed-top shadow-sm" id=navbar-main-menu><div class=container><a class="navbar-brand font-weight-bold" href=https://ryuchen.club>>$ cd /home_</a>
<button class=navbar-toggler type=button data-toggle=collapse data-target=#main-menu aria-controls=main-menu aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=main-menu><ul class="navbar-nav ml-auto"><li class=nav-item><a class=nav-link href=/>首页</a></li><li class=nav-item><a class=nav-link href=/posts/>博文</a></li><li class=nav-item><a class=nav-link href=/projects/>项目</a></li><li class=nav-item><a class=nav-link href=/snippet/>代码</a></li><li class=nav-item><a class=nav-link href=/essay/>随笔</a></li><li class=nav-item><a class=nav-link href=/gallery/>照片墙</a></li><li class=nav-item><a class=nav-link href=/about/>关于</a></li><li class=nav-item><a class=nav-link href=https://github.com/Ryuchen target=_blank>Github</a></li></ul></div></div></nav><main class="content-page container pt-7 pb-5"><div class=row><div class=col><article><div class="row justify-content-center"><div class=col-lg-10><h1>JWT认证系统尝鲜</h1><div class="meta text-muted mb-3" style=text-align:right><p class="created text-muted text-uppercase font-weight-bold mb-1">August 1, 2019</p><span class=mr-2><i class="fas fa-book-open mr-2"></i>3451</span>
<span><i class="fas fa-clock mr-2"></i>15 minutes and
41 seconds</span></div><div class="category my-3"><a class="badge badge-pill badge-light border mr-2" href=/categories/%E5%85%A8%E6%A0%88%E7%B3%BB%E5%88%97><i class="fas fa-tag mr-2"></i>全栈系列</a></div></div></div><div class="row justify-content-center mb-3"><div class=col-lg-10><img data-src=/images/JWT_hud8dcf04dcc67e8aaa6fd17c95450ee0d_42274_900x500_fit_box_2.png class="img-fluid rounded mx-auto d-block" alt=JWT认证系统尝鲜></div></div><div class="row justify-content-center"><div class=col-lg-10><div class=content><h3 id=简介一下技术栈>简介一下技术栈</h3><h4 id=what-is-jwt-token>What is jwt token</h4><p>其实什么是 jwt 认证系统，这个已经不是什么新的技术了，但是由于之前一直在 toB 的企业中天天浑浑噩噩的，所以没有地方用到过这类的技术（不得不感慨，前端技术的话，还是 toC 的企业用的比较新比较全，毕竟开发效率是第一生产力 <code>>.0</code>），现在我介绍这个东西也算是老调重弹，或者说赶个晚集。
jwt 全称（JSON WEB TOKEN）是一套开放的认证系统标准，它的定义宗旨是使用一套简洁的且安全的方案，在客户端和服务端认证之间安全的传输 JSON 格式的认证信息。
介绍就是这么的简单，完全不需要任何高深度的理解，就是服务端和客户端把认证信息变成了 JSON 在传输而已，掌握起来并没有任何难度，但是什么时候使用它以及为什么使用这个就是在集成过程中特别需要注意的地方了，不过这部分内容，先按下不表，后面段落中再详细说明。</p><h4 id=ng-alain>ng-alain</h4><p>ng-alain 这个框架或者说是前端构建脚手架，相信使用的人还不是很多，目前在网上似乎我也搜不到什么帮助问答，不过我个人还是很看好这个框架的（其实是我个人倾向前端的 angular 技术，别问为什么，问就是 react 和 vue 不如它，PS：后期还是会好好学习 react 和 vue 的，期待&rsquo;真香&rsquo;时刻）。
首先它是基于 angular 的一套完善的中后台解决方案了，也算是我在学习 angular 过程中发现的一套不过的框架结构，不过我才使用几天就发现了一些令我头疼的问题，不过还是很值得期待后续它是如何发展的，毕竟出自阿里的 ant-design 系统的一套独立系统，并且更新还是很频繁的~
其实，在 angluar 还有使用 ng-alain 上面我都是一个刚入门的小菜鸡，所以总结不出什么高大上的介绍语，所以还是引用一句官方的话来简单介绍它吧：<code>NG-ALAIN 是一个企业级中后台前端/设计解决方案脚手架，我们秉承 Ant Design 的设计价值观，目标也非常简单，希望在Angular上面开发企业后台更简单、更快速。随着『设计者』的不断反馈，将持续迭代，逐步沉淀和总结出更多设计模式和相应的代码实现，阐述中后台产品模板/组件/业务场景的最佳实践，也十分期待你的参与和共建。</code>
<a href=https://ng-alain.com/docs/getting-started/zh>ng-alin地址: https://ng-alain.com/docs/getting-started/zh</a></p><h3 id=why-choose-jwt--ng-alain>Why choose jwt & ng-alain</h3><p>选择一个东西，肯定得有挑选它的理由（PS：我在我的项目使用只是想用，就是这么任性~ 此外也是因为正好 ng-alain 中提供了 JWTInterceptor ）。</p><h4 id=jwt-的优点>JWT 的优点</h4><ul><li>它有严谨的结构化数据体征，它自身存在 payload 字段可以包含用户的自定义验证信息，这里，在服务端进行校验时，就不需要再去进行查询来判断当前用户的有效性了，当然你还可以往里面塞一些其他信息，不过不建议塞过多的东西，毕竟他是用<a href=https://ryuchen.github.io/2019/06/22/%E5%85%B3%E4%BA%8ERESTful%E9%A3%8E%E6%A0%BC%E7%9A%84API%E7%BC%96%E5%86%99%E6%A0%87%E5%87%86%E7%9A%84%E6%8E%A2%E8%AE%A8/>heard 头部信息（PS：之前的文章我里面提到过）</a>进行传输的，体积小是它的特征，如果不遵守使用的太过了，就会导致一些不必要的问题。</li><li>它在前后端分离和跨平台项目中可是利器，无论是之前的 cookie 还是 session 都是有状态 restful api 验证，而 JWT 可以进行无状态的 rest api 验证，说白了就是服务端不进行状态的保留，而把登录状态的保留工作交给了客户端，需要客户端将每次 api 的请求头都带上所需要的信息，这样每个 api 之间都是独立的。</li><li>无需使用特定的身份验证方式，只要拥有公司制定的标准格式的验证信息，生成的的 token 值可以在所有的产品接口中通用，无需繁琐的耦合验证操作，一次生成，永久使用，是不是很爽？这个难道就是传说中的单点登录？</li></ul><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=o>//</span> <span class=n>Header</span>
<span class=p>{</span>
  <span class=s2>&#34;alg&#34;</span><span class=p>:</span> <span class=s2>&#34;HS256&#34;</span><span class=p>,</span>
  <span class=s2>&#34;typ&#34;</span><span class=p>:</span> <span class=s2>&#34;JWT&#34;</span>
<span class=p>}</span>

<span class=o>//</span> <span class=n>Payload</span>
<span class=p>{</span>
  <span class=o>//</span> <span class=n>reserved</span> <span class=n>claims</span>
  <span class=s2>&#34;iss&#34;</span><span class=p>:</span> <span class=s2>&#34;a.com&#34;</span><span class=p>,</span>
  <span class=s2>&#34;exp&#34;</span><span class=p>:</span> <span class=s2>&#34;1d&#34;</span><span class=p>,</span>
  <span class=o>//</span> <span class=n>public</span> <span class=n>claims</span>
  <span class=s2>&#34;http://a.com&#34;</span><span class=p>:</span> <span class=n>true</span><span class=p>,</span>
  <span class=o>//</span> <span class=n>private</span> <span class=n>claims</span>
  <span class=s2>&#34;company&#34;</span><span class=p>:</span> <span class=s2>&#34;A&#34;</span><span class=p>,</span>
  <span class=s2>&#34;awesome&#34;</span><span class=p>:</span> <span class=n>true</span>
<span class=p>}</span>

<span class=o>//</span> <span class=err>$</span><span class=n>Signature</span>
<span class=n>HS256</span><span class=p>(</span><span class=n>Base64</span><span class=p>(</span><span class=n>Header</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;.&#34;</span> <span class=o>+</span> <span class=n>Base64</span><span class=p>(</span><span class=n>Payload</span><span class=p>),</span> <span class=n>secretKey</span><span class=p>)</span>

<span class=o>//</span> <span class=n>JWT</span>
<span class=n>JWT</span> <span class=o>=</span> <span class=n>Base64</span><span class=p>(</span><span class=n>Header</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;.&#34;</span> <span class=o>+</span> <span class=n>Base64</span><span class=p>(</span><span class=n>Payload</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;.&#34;</span> <span class=o>+</span> <span class=err>$</span><span class=n>Signature</span>
</code></pre></div><p>JWT 在验证过程中前后端的交互过程和工作原理</p><p><img src=/images/15637621948197.jpg alt=image></p><h4 id=选择-ng-alain-的原因>选择 ng-alain 的原因</h4><p>首先 angluar 我也是入门者，但是我是标准的后端转前端，所以没什么好说的就是 angular 看着顺眼，这种写法深得我心，然后官网撸一撸文档，看看视频，基本差不多可以入手了，写着写着就不太对劲了。因为之前我写过一段时间的 react，我 T 喵的怎么发现 angular 比 react 还难写，没道理啊，我感觉从概念和代码上看，完全适合后端这种拆分模块的思虑啊，特别像 python 的 class 和 moduel 啊，怎么写起来这么难。没办法啊，再硬的骨头，怎么也得自己啃吧，不能因为难就放弃了吧，毕竟自己打算做一个独立开发人员，这点实力还是得有的，于是在网上搜集成熟的框架进行实打实的实战学习，于是就发现了神器->ng-alain。</p><p>其实这里我也是经历了很久的筛选过程的，不过我自己有几个标准：</p><ul><li>一定是遵循某一特定的设计理念，这点对于独立开发人员很重要，因为你不是一个设计师（PS:你要是真的艺术细胞爆棚也无敌），所以不能够拿出惨不忍睹的东西出来面人，所以一整套完善的开源设计体系是你需要的</li><li>一定是有严格的开发标准的，即使是对于独立开发者来说，我还是觉得规则比开发本身更重要，因为我真的是受了太多的这种坑了，有许许多多问题都是因为你东抄一点西抄一点最后导致哪里出了问题都找不到</li><li>一定是有发展潜力的开源框架，独立开发者可能有很多是大牛，直接自己手撸框架了，但是自己还诚然不是那种人，所以要选择一个对自己有利的开源框架，这个框架能够辅助自己的开发效率，此外，这个框架一定要频繁的更新，并且能够快速反馈，当然，最好的是起步阶段的项目，为什么不是稳定的？因为只有在一直处理问题的时候你才能，更深入的去学习框架代码，才能自己写好框架，为以后自己手撸框架做铺垫</li></ul><h3 id=如何集成>如何集成</h3><p>说了这么多，终于要开始把上述的功能点集成到一起了~ 不过这里我并不是从零开始一步一步手把手复述一遍集成过程，而是把一些主要的地方或者自己觉得需要注意的点备注一下：</p><h4 id=后端集成-jwt>后端集成 jwt</h4><p>首先是服务端集成 jwt 这个功能，这里使用的是 <a href=http://jpadilla.github.io/django-rest-framework-jwt/>django-rest-framework-jwt</a> 这个插件，将这个插件安装之后，可以按照文档直接集成它自己的接口，不过我自己之前写过 restful api 的 login 接口了于是采用了手工集成的方式</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=nd>@api_view</span><span class=p>([</span><span class=s2>&#34;POST&#34;</span><span class=p>])</span>
<span class=nd>@authentication_classes</span><span class=p>(())</span>
<span class=nd>@permission_classes</span><span class=p>(())</span>
<span class=nd>@excepts</span>
<span class=k>def</span> <span class=nf>login_view</span><span class=p>(</span><span class=n>request</span><span class=p>):</span>
    <span class=s2>&#34;&#34;&#34;
</span><span class=s2>    用于账户登录接口
</span><span class=s2>    :param request:
</span><span class=s2>    :return:
</span><span class=s2>    &#34;&#34;&#34;</span>
    <span class=n>res</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&#34;code&#34;</span><span class=p>:</span> <span class=s2>&#34;00000000&#34;</span><span class=p>,</span>
        <span class=s2>&#34;data&#34;</span><span class=p>:</span> <span class=p>{}</span>
    <span class=p>}</span>

    <span class=n>username</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>POST</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>)</span>
    <span class=n>password</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>POST</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>)</span>
    <span class=n>remember</span> <span class=o>=</span> <span class=n>request</span><span class=o>.</span><span class=n>POST</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;remember&#39;</span><span class=p>)</span>

    <span class=n>jwt_payload_handler</span> <span class=o>=</span> <span class=n>token_settings</span><span class=o>.</span><span class=n>JWT_PAYLOAD_HANDLER</span> <span class=c1># 关键代码</span>
    <span class=n>jwt_encode_handler</span> <span class=o>=</span> <span class=n>token_settings</span><span class=o>.</span><span class=n>JWT_ENCODE_HANDLER</span> <span class=c1># 关键代码</span>

    <span class=n>user</span> <span class=o>=</span> <span class=n>authenticate</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>username</span><span class=o>=</span><span class=n>username</span><span class=p>,</span> <span class=n>password</span><span class=o>=</span><span class=n>password</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>user</span> <span class=ow>is</span> <span class=ow>not</span> <span class=bp>None</span><span class=p>:</span>
        <span class=n>login</span><span class=p>(</span><span class=n>request</span><span class=p>,</span> <span class=n>user</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>remember</span><span class=p>:</span>
            <span class=n>token_settings</span><span class=o>.</span><span class=n>JWT_EXPIRATION_DELTA</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>hours</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span> <span class=c1># 暂不生效后续需要改动</span>

        <span class=n>payload</span> <span class=o>=</span> <span class=n>jwt_payload_handler</span><span class=p>(</span><span class=n>user</span><span class=p>)</span>
        <span class=n>token</span> <span class=o>=</span> <span class=n>jwt_encode_handler</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
        <span class=n>res</span><span class=p>[</span><span class=s1>&#39;data&#39;</span><span class=p>][</span><span class=s1>&#39;token&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>token</span>
        <span class=k>return</span> <span class=n>JsonResponse</span><span class=p>(</span><span class=n>res</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>raise</span> <span class=n>AuthenticateError</span><span class=p>(</span><span class=s2>&#34;Username or Password is incorrect!&#34;</span><span class=p>)</span>
</code></pre></div><p>然后按照官方的提示，将 django-rest-framework-jwt 的认证方式添加到 settings.py 里面就行了，但是这里有个<strong>非常重要的问题</strong>，就是这个插件自己自带的 jwt token heard 的前缀是错误的，需要自己进行修改，这个地方真的是要感慨自己当初不好好看文档，这里我折腾了好久，还把 ng-alain 的认证方式和源码撸了一遍，其中还是用过 SimpleInterceptor 做过 ng-alain 的认证拦截器！！！</p><p>其实只需要把官方的配置文件中梳理仔细读一遍就可以知道了，官方的配置项目里面有能够修改的地方的。</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>JWT_AUTH</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>&#39;JWT_ENCODE_HANDLER&#39;</span><span class=p>:</span>
    <span class=s1>&#39;rest_framework_jwt.utils.jwt_encode_handler&#39;</span><span class=p>,</span>

    <span class=s1>&#39;JWT_DECODE_HANDLER&#39;</span><span class=p>:</span>
    <span class=s1>&#39;rest_framework_jwt.utils.jwt_decode_handler&#39;</span><span class=p>,</span>

    <span class=s1>&#39;JWT_PAYLOAD_HANDLER&#39;</span><span class=p>:</span>
    <span class=s1>&#39;rest_framework_jwt.utils.jwt_payload_handler&#39;</span><span class=p>,</span>

    <span class=s1>&#39;JWT_PAYLOAD_GET_USER_ID_HANDLER&#39;</span><span class=p>:</span>
    <span class=s1>&#39;rest_framework_jwt.utils.jwt_get_user_id_from_payload_handler&#39;</span><span class=p>,</span>

    <span class=s1>&#39;JWT_RESPONSE_PAYLOAD_HANDLER&#39;</span><span class=p>:</span>
    <span class=s1>&#39;rest_framework_jwt.utils.jwt_response_payload_handler&#39;</span><span class=p>,</span>

    <span class=s1>&#39;JWT_SECRET_KEY&#39;</span><span class=p>:</span> <span class=n>SECRET_KEY</span><span class=p>,</span>
    <span class=s1>&#39;JWT_GET_USER_SECRET_KEY&#39;</span><span class=p>:</span> <span class=bp>None</span><span class=p>,</span>
    <span class=s1>&#39;JWT_PUBLIC_KEY&#39;</span><span class=p>:</span> <span class=bp>None</span><span class=p>,</span>
    <span class=s1>&#39;JWT_PRIVATE_KEY&#39;</span><span class=p>:</span> <span class=bp>None</span><span class=p>,</span>
    <span class=s1>&#39;JWT_ALGORITHM&#39;</span><span class=p>:</span> <span class=s1>&#39;HS256&#39;</span><span class=p>,</span>
    <span class=s1>&#39;JWT_VERIFY&#39;</span><span class=p>:</span> <span class=bp>True</span><span class=p>,</span>
    <span class=s1>&#39;JWT_VERIFY_EXPIRATION&#39;</span><span class=p>:</span> <span class=bp>True</span><span class=p>,</span>
    <span class=s1>&#39;JWT_LEEWAY&#39;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=s1>&#39;JWT_EXPIRATION_DELTA&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>1</span><span class=p>),</span>
    <span class=s1>&#39;JWT_AUDIENCE&#39;</span><span class=p>:</span> <span class=bp>None</span><span class=p>,</span>
    <span class=s1>&#39;JWT_ISSUER&#39;</span><span class=p>:</span> <span class=bp>None</span><span class=p>,</span>

    <span class=s1>&#39;JWT_ALLOW_REFRESH&#39;</span><span class=p>:</span> <span class=bp>False</span><span class=p>,</span>
    <span class=s1>&#39;JWT_REFRESH_EXPIRATION_DELTA&#39;</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=mi>7</span><span class=p>),</span>

    <span class=s1>&#39;JWT_AUTH_HEADER_PREFIX&#39;</span><span class=p>:</span> <span class=s1>&#39;Bearer&#39;</span><span class=p>,</span>  <span class=c1># 就是这个地方！！！！！！</span>
    <span class=s1>&#39;JWT_AUTH_COOKIE&#39;</span><span class=p>:</span> <span class=bp>None</span><span class=p>,</span>
<span class=p>}</span>
</code></pre></div><h4 id=前端集成-jwt>前端集成 jwt</h4><p>其实 ng-alain 本身就已经自带了 JWTInterceptor，这里只需要开启就可以了
首先是配置请求拦截器，将 JWT 认证拦截器注册进去</p><div class=highlight><pre class=chroma><code class=language-Typescript data-lang=Typescript><span class=c1>// app.module.ts
</span><span class=c1>// #region Http Interceptors
</span><span class=c1></span><span class=kr>import</span> <span class=p>{</span> <span class=nx>HTTP_INTERCEPTORS</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@angular/common/http&#39;</span><span class=p>;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>JWTInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@delon/auth&#39;</span><span class=p>;</span>
<span class=kr>import</span> <span class=p>{</span> <span class=nx>DefaultInterceptor</span> <span class=p>}</span> <span class=kr>from</span> <span class=s1>&#39;@core/net/default.interceptor&#39;</span><span class=p>;</span>
<span class=kr>const</span> <span class=nx>INTERCEPTOR_PROVIDES</span> <span class=o>=</span> <span class=p>[</span>
  <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>HTTP_INTERCEPTORS</span><span class=p>,</span> <span class=nx>useClass</span>: <span class=kt>DefaultInterceptor</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span> <span class=p>},</span>
  <span class=p>{</span> <span class=nx>provide</span>: <span class=kt>HTTP_INTERCEPTORS</span><span class=p>,</span> <span class=nx>useClass</span>: <span class=kt>JWTInterceptor</span><span class=p>,</span> <span class=nx>multi</span>: <span class=kt>true</span> <span class=p>},</span>
<span class=p>];</span>
<span class=c1>// #endregion
</span></code></pre></div><p>然后是在启动过程中，进行 token 的校验，判断当前用户是否已经登录了，是否从后端请求用户的详细信息</p><div class=highlight><pre class=chroma><code class=language-Typescript data-lang=Typescript><span class=c1>// startup.service.ts
</span><span class=c1></span><span class=p>...</span>
<span class=c1>// 启动的时候判断当前有没有存储 token 值，如果存储则直接跳转到首页，否则跳转到登录页面
</span><span class=c1></span>  <span class=kr>const</span> <span class=nx>tokenData</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>tokenService</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=nx>JWTTokenModel</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>tokenData</span><span class=p>.</span><span class=nx>token</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>httpClient</span><span class=p>.</span><span class=kr>get</span><span class=p>(</span><span class=s1>&#39;accounts/current/&#39;</span><span class=p>).</span><span class=nx>subscribe</span><span class=p>(</span><span class=nx>userData</span> <span class=o>=&gt;</span> <span class=p>{</span>
      <span class=c1>// User information: including name, avatar, email address
</span><span class=c1></span>      <span class=kr>const</span> <span class=p>{</span>
        <span class=nx>data</span><span class=o>:</span> <span class=p>{</span> <span class=nx>profile</span><span class=p>,</span> <span class=nx>authority</span><span class=p>,</span> <span class=nx>permission</span> <span class=p>},</span>
      <span class=p>}</span> <span class=o>=</span> <span class=nx>userData</span> <span class=kr>as</span> <span class=kt>any</span><span class=p>;</span>

      <span class=c1>// 设置用户的认证信息
</span><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>sessionStorageService</span><span class=p>.</span><span class=nx>store</span><span class=p>(</span><span class=s1>&#39;authority&#39;</span><span class=p>,</span> <span class=nx>authority</span><span class=p>);</span>
      <span class=k>this</span><span class=p>.</span><span class=nx>sessionStorageService</span><span class=p>.</span><span class=nx>store</span><span class=p>(</span><span class=s1>&#39;permission&#39;</span><span class=p>,</span> <span class=nx>permission</span><span class=p>);</span>

      <span class=k>this</span><span class=p>.</span><span class=nx>settingService</span><span class=p>.</span><span class=nx>setUser</span><span class=p>(</span><span class=nx>profile</span><span class=p>);</span>
    <span class=p>});</span>
  <span class=p>}</span>
<span class=p>...</span>
</code></pre></div><p>最后在登录的代码段里面加上保存用户 jwt token 信息的代码就搞定了，是不是很 easy~</p><div class=highlight><pre class=chroma><code class=language-Typescript data-lang=Typescript>  <span class=nx>submitLogin() {</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>markAsDirty</span><span class=p>();</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>updateValueAndValidity</span><span class=p>();</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>password</span><span class=p>.</span><span class=nx>markAsDirty</span><span class=p>();</span>
    <span class=k>this</span><span class=p>.</span><span class=nx>password</span><span class=p>.</span><span class=nx>updateValueAndValidity</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>invalid</span> <span class=o>||</span> <span class=k>this</span><span class=p>.</span><span class=nx>password</span><span class=p>.</span><span class=nx>invalid</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=kr>const</span> <span class=nx>formData</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>FormData</span><span class=p>();</span>
    <span class=nx>formData</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;username&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>username</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
    <span class=nx>formData</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;password&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>password</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>
    <span class=nx>formData</span><span class=p>.</span><span class=nx>append</span><span class=p>(</span><span class=s1>&#39;remember&#39;</span><span class=p>,</span> <span class=k>this</span><span class=p>.</span><span class=nx>remember</span><span class=p>.</span><span class=nx>value</span><span class=p>);</span>

    <span class=c1>// 默认配置中对所有HTTP请求都会强制 [校验](https://ng-alain.com/auth/getting-started) 用户 Token
</span><span class=c1></span>    <span class=c1>// 然一般来说登录请求不需要校验，因此可以在请求URL加上：`/login?_allow_anonymous=true` 表示不触发用户 Token 校验
</span><span class=c1></span>    <span class=k>this</span><span class=p>.</span><span class=nx>http</span><span class=p>.</span><span class=nx>post</span><span class=p>(</span><span class=s1>&#39;accounts/login/?_allow_anonymous=true&#39;</span><span class=p>,</span> <span class=nx>formData</span><span class=p>).</span><span class=nx>subscribe</span><span class=p>((</span><span class=nx>res</span>: <span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
      <span class=c1>// 保存用户的 token 信息在缓存里面
</span><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>tokenService</span><span class=p>.</span><span class=kr>set</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>data</span><span class=p>);</span>

      <span class=c1>// 重新获取 StartupService 内容，我们始终认为应用信息一般都会受当前用户授权范围而影响
</span><span class=c1></span>      <span class=k>this</span><span class=p>.</span><span class=nx>startupService</span><span class=p>.</span><span class=nx>load</span><span class=p>().</span><span class=nx>then</span><span class=p>(()</span> <span class=o>=&gt;</span> <span class=p>{</span>
        <span class=kd>let</span> <span class=nx>url</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>tokenService</span><span class=p>.</span><span class=nx>referrer</span><span class=o>!</span><span class=p>.</span><span class=nx>url</span> <span class=o>||</span> <span class=s1>&#39;/&#39;</span><span class=p>;</span>
        <span class=k>if</span> <span class=p>(</span><span class=nx>url</span><span class=p>.</span><span class=nx>includes</span><span class=p>(</span><span class=s1>&#39;/passport&#39;</span><span class=p>))</span> <span class=p>{</span>
          <span class=nx>url</span> <span class=o>=</span> <span class=s1>&#39;/&#39;</span><span class=p>;</span>
        <span class=p>}</span>
        <span class=k>this</span><span class=p>.</span><span class=nx>router</span><span class=p>.</span><span class=nx>navigateByUrl</span><span class=p>(</span><span class=nx>url</span><span class=p>);</span>
      <span class=p>});</span>
    <span class=p>});</span>
  <span class=p>}</span>
</code></pre></div><p>这里要说一句 ng-alain 的 JWTInterceptor 还提供了判断是否过期的功能，解析 payload 的功能，这部分真的很实用！</p><h3 id=总结>总结</h3><p>虽然只是简单的集成工作，但是其实我也摸索了不少时间，这里算是头一次使用这个认证系统，也算是弥补了之前的自己的遗憾，没有在公司项目中用上，不过这里也不算是完全使用了，因为在集成过程中还特意看了下标准的使用方法，以及集成第三方的方式，发现，一般返回给客户端的通常会包含两个 token 值，一个是 access_token 一个是 refresh_token，这两个光看名字就知道是该如何使用了，当 access_token 过期了，使用 refresh_token 进行刷新，就可以继续访问了，通常情况下 refresh_token 是长期保存的，可以根据用户的申请的过程中进行时间设定，然后是 access_token 通常是设置短一点的时间，这样可以帮助用户传输过程中的安全。
不过我发现 django-rest-framework-jwt 这个插件，并没有这个功能，或者说它定义的 refresh 概念并不是一样的，所以，后续还是得手撸一个插件比较靠谱，虽然会很慢，但是后续自己的项目中，这么使用会一本万利~</p></div><div class="tags my-3"><a class="badge badge-pill badge-light border mr-2" href=/tags/django/><i class="fas fa-tag mr-2"></i>django
</a><a class="badge badge-pill badge-light border mr-2" href=/tags/angular/><i class="fas fa-tag mr-2"></i>angular
</a><a class="badge badge-pill badge-light border mr-2" href=/tags/ng-alain/><i class="fas fa-tag mr-2"></i>ng-alain</a></div><div style=text-align:center><div class=social-share data-sites=wechat,weibo,twitter,facebook,douban data-mobile-sites=wechat,weibo></div></div></div></div><div class="row justify-content-center"><div class=col-lg-8><div id=comments-gittalk></div><link rel=stylesheet href=https://unpkg.com/gitalk/dist/gitalk.css><script src=https://unpkg.com/gitalk/dist/gitalk.min.js></script><script>var gittalk=new Gitalk({id:'0x000006',owner:'Ryuchen',repo:'ryuchen.github.io',admin:['Ryuchen'],clientID:'cda75f43f62ef6ebc3ea',clientSecret:'e405fb603c664a6436a481917a7ee70931413268',})
gittalk.render('comments-gittalk')</script></div></div></article></div></div><div class="related-content row mt-5 row-cols-1 row-cols-lg-3"><div class="col mb-3"><div class="card h-100 shadow"><a href=/posts/0x000003/ class=d-block><img data-src=https://cdn.jsdelivr.net/gh/Ryuchen/ryuchen.github.io@master/images/django-middleware_hu30d1361442ea7531add7805411959c47_325751_700x350_resize_q75_box.jpeg class="card-img-top mx-auto d-block" alt=Django中间件的理解><div class=card-body><div class=card-title>Django中间件的理解</div><div class=card-serie><span class="badge badge-pill badge-primary">生活感悟</span> &nbsp;<span class="badge badge-pill badge-primary">全栈系列</span> &nbsp;</div><p class="card-text text-muted text-uppercase">July 6, 2019</p><div class=card-text>这篇文章的主要目的是帮助自己总结下过去使用 django 中间件中发生的问题的时候，需要进行注意的地方，那是在一次审查 django 在接收前端请求过程中过慢的问题，后续发现是中间件中频繁对文本资源进行读取，而且还通过递归的方式进行了文件的遍历，造成效率的低下，于是总结了一下经验。</div></div></a></div></div><div class="col mb-3"><div class="card h-100 shadow"><a href=/posts/0x000002/ class=d-block><img data-src=https://cdn.jsdelivr.net/gh/Ryuchen/ryuchen.github.io@master/images/markdown-syntax_hu82f81192e936314d551c0b466c7e7bbb_24890_700x350_resize_q75_box.jpg class="card-img-top mx-auto d-block" alt=企业前端开发隔离方案><div class=card-body><div class=card-title>企业前端开发隔离方案</div><div class=card-serie><span class="badge badge-pill badge-primary">生活感悟</span> &nbsp;<span class="badge badge-pill badge-primary">开发环境</span> &nbsp;<span class="badge badge-pill badge-primary">全栈系列</span> &nbsp;</div><p class="card-text text-muted text-uppercase">June 29, 2019</p><div class=card-text>之前的工作环境中，由于系统的整体性过于强，尤其是对于面向企业级客户的单机项目中，解耦合程度不高的情况下，我们无法让多位开发人员共享一台开发环境，导致最终造成开发效率低下和开发成本过高，对于这个问题我也思考了很久，后来整理了一些自己的看法和方式，形成了下面的文章，算是面向以前的经验和教训</div></div></a></div></div><div class="col mb-3"><div class="card h-100 shadow"><a href=/posts/0x000001/ class=d-block><img data-src=https://cdn.jsdelivr.net/gh/Ryuchen/ryuchen.github.io@master/images/rest-api_hudb79f3b2fdcf233b59c1a09abb235c3d_54278_700x350_resize_box_2.png class="card-img-top mx-auto d-block" alt=谈谈RESTfulAPI标准理解><div class=card-body><div class=card-title>谈谈RESTfulAPI标准理解</div><div class=card-serie><span class="badge badge-pill badge-primary">生活感悟</span> &nbsp;<span class="badge badge-pill badge-primary">全栈系列</span> &nbsp;</div><p class="card-text text-muted text-uppercase">June 22, 2019</p><div class=card-text>通过工作实践过程中，总结的一些关于在进行前后端分离过程中的 restful api 编写规范，主要是来自于自己工作的心得，并且并不是完全的在工作场景下的使用情况，但是具体的内容也算是广泛查看了各路大神的总结，或多或少对接口编写有些指导作用，适用于以后自己的项目实战。</div></div></a></div></div></div></main><footer class="footer bg-dark py-6"><div class=container><div class=row><div class="col-sm text-center"><ul class=list-inline><li class=list-inline-item><a href=https://ryuchen.club/index.xml rel=alternate type=application/rss+xml class="icons d-block"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-rss fa-stack-1x fa-inverse"></i></span></a></li><li class=list-inline-item><a href=mailto:chenhaom1993@hotmail.com class="icons d-block"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li class=list-inline-item><a href=https://github.com/Ryuchen class="icons d-block"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li class=list-inline-item><a href=https://weibo.com/u/3147247770 class="icons d-block"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fab fa-weibo fa-stack-1x fa-inverse"></i></span></a></li></ul><p class=text-muted>Copyright © 2018–2020, WangOO and Ryuchen, all rights reserved.</p><p class=text-muted>京ICP备2020040667号</p><p class=text-muted>本站总记被访问 <span id=busuanzi_value_site_pv></span>次，
您是第 <span id=busuanzi_value_site_uv></span>个来访小伙伴。</p></div><div class="col-sm text-center"><p class=text-muted>维护不易，渴望您的资助</p><ul class=list-inline><div class=row><div class="col-sm text-center"><li class=list-inline-item><img src=https://cdn.jsdelivr.net/gh/Ryuchen/ImageBed@sponsor/wechat.jpg alt=WechatPay class=loaded data-was-processed=true style=width:140px;padding:4px></li></div><div class="col-sm text-center"><li class=list-inline-item><img src=https://cdn.jsdelivr.net/gh/Ryuchen/ImageBed@sponsor/alipay.jpg alt=AliPay class=loaded data-was-processed=true style=width:140px;padding:4px></li></div></div></ul></div></div></div><div class=netease-music><audio id=music-player crossorigin playsinline></audio></div></footer><script src=/dist/main.bf9558b8596b4accd07a.min.js></script><script src=https://cdn.jsdelivr.net/gh/Ryuchen/ryuchen.github.io@master//mermaid/mermaid.js></script><script>window.Prism=window.Prism||{};</script><script src=https://cdn.jsdelivr.net/npm/prismjs@1.22.0/prism.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1.22.0/plugins/autoloader/prism-autoloader.min.js></script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>(function(){var bp=document.createElement('script');var curProtocol=window.location.protocol.split(':')[0];if(curProtocol==='https'){bp.src='https://zz.bdstatic.com/linksubmit/push.js';}
else{bp.src='http://push.zhanzhang.baidu.com/push.js';}
var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(bp,s);})();</script><script>(function(){var el=document.createElement("script");el.src="https://s3a.pstatp.com/toutiao/push.js?1b349c44e658214c68be3a649c8dd67d03df3ccff5cf4d26c95620535e04d891417631efa03c64873bef9496a5c9bb7c62f7c4af6b1a55b161baff8a0b4e2fba";el.id="ttzz";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(el,s);})(window)</script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js integrity="sha256-fGPu+icKh985TLPhO2v68U7i0CW0dE4kiR06RN4O6jo=" crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-0EFH27TG1R"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-0EFH27TG1R');</script></body></html>